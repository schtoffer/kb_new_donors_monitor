{% extends "layout.html" %}

{% block title %}Faste Givere{% endblock %}

{% block head_scripts %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/css/bootstrap.min.css">
{% endblock %}

{% block additional_styles %}
<style>
    body {
        text-align: center;
    }
    
    .container {
        margin-top: 15px !important;
    }
    
    h1 {
        color: rgb(33, 31, 32);
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        font-size: 20px;
        font-weight: 700;
        margin: 0 0 10px 0;
        padding: 0;
        text-align: center;
    }
    
    .donors-table {
        width: 100%;
        max-width: 400px;
        margin: 20px auto;
        border-collapse: collapse;
        background-color: white;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        border-radius: 8px;
        overflow: hidden;
        font-size: 12px;
    }
    
    .donors-table th {
        background-color: var(--primary-color);
        color: white;
        padding: 6px 8px;
        text-align: left;
        font-weight: 600;
        font-size: 11px;
    }
    
    .donors-table td {
        padding: 5px 8px;
        border-bottom: 1px solid #eee;
        text-align: left;
        white-space: nowrap;
    }
    
    .donors-table tr:last-child td {
        border-bottom: none;
    }
    
    .donors-table tr:nth-child(even) {
        background-color: #f9f9f9;
    }
    
    .donors-table tr:hover {
        background-color: #f1f1f1;
    }
    
    .summary-box {
        background-color: white;
        border-radius: 8px;
        padding: 15px;
        margin: 20px auto;
        max-width: 400px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    
    .summary-stat {
        display: inline-block;
        margin: 0 20px;
        text-align: center;
    }
    
    .summary-value {
        font-size: 22px;
        font-weight: bold;
        color: var(--primary-color);
    }
    
    .summary-label {
        font-size: 14px;
        color: #666;
    }
    
    .payment-method {
        display: inline-block;
        padding: 2px 4px;
        border-radius: 3px;
        font-size: 10px;
        font-weight: 600;
        color: white;
        background-color: #6c757d;
    }
    
    .payment-method.Vipps {
        background-color: #ff5b24; /* Orange for Vipps */
    }
    
    .payment-method.SMS {
        background-color: #28a745; /* Green for SMS */
    }
    
    .payment-method.Stripe {
        background-color: #007bff; /* Blue for Stripe */
    }
    
    .payment-method.Avtalegiro {
        background-color: #6c757d; /* Gray for Avtalegiro */
    }
    
    .payment-method-link {
        text-decoration: none;
        display: inline-block;
    }
    
    .payment-method-link:hover .payment-method {
        opacity: 0.9;
        transform: scale(1.05);
        transition: all 0.2s ease;
    }
    
    .donor-link {
        color: #0066cc;
        text-decoration: none;
        font-weight: 500;
    }
    
    .donor-link:hover {
        text-decoration: underline;
        color: #004c99;
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <h1>Faste Givere</h1>
    
    <div class="filter-controls mb-3">
        <div class="row justify-content-center">
            <div class="col-12 mb-2">
                <label for="product-filter" class="small">Produkt:</label>
                <select id="product-filter" class="form-control form-control-sm">
                    <option value="">Alle</option>
                    {% for product in products %}
                    <option value="{{ product }}">{{ product }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-12 mb-2">
                <label for="date-filter-from" class="small">Fra dato:</label>
                <input type="date" id="date-filter-from" class="form-control form-control-sm">
            </div>
            <div class="col-12">
                <label for="date-filter-to" class="small">Til dato:</label>
                <input type="date" id="date-filter-to" class="form-control form-control-sm">
            </div>
        </div>
    </div>
    
    <div class="summary-box">
        <div class="summary-stat">
            <div class="summary-value">{{ total_donors }}</div>
            <div class="summary-label">Totalt antall givere</div>
        </div>
        <div class="summary-stat">
            <div class="summary-value">{{ total_amount|int }} kr</div>
            <div class="summary-label">Månedlig beløp</div>
        </div>
    </div>
    
    <table class="donors-table">
        <thead>
            <tr>
                <th>Avtale</th>
                <th>Årsbeløp</th>
                <th>Startdato</th>
                <th>Produkt</th>
            </tr>
        </thead>
        <tbody>
            {% for donor in donors %}
            <tr>
                <td>
                    <a href="https://bymisjon.profundo.no/crm/navn/{{ donor.name_id }}/avtale/{{ donor.agreement_number }}" target="_blank" class="payment-method-link" title="Åpne avtale i Profundo">
                        <span class="payment-method {{ donor.payment_method }}">
                            {{ donor.payment_method }} ↗
                        </span>
                    </a>
                </td>
                <td><span style="white-space: nowrap;">{{ donor.amount|int }} kr</span></td>
                <td>{{ donor.startdate }}</td>
                <td>{{ donor.producttype_id }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endblock %}

{% block scripts %}
<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    $(document).ready(function() {
        // Filter by product
        $('#product-filter').on('change', function() {
            var selectedProduct = $(this).val();
            filterTable();
        });
        
        // Filter by start date range
        $('#date-filter-from, #date-filter-to').on('change', function() {
            filterTable();
        });
        
        function filterTable() {
            var selectedProduct = $('#product-filter').val();
            var fromDate = $('#date-filter-from').val();
            var toDate = $('#date-filter-to').val();
            
            $('.donors-table tbody tr').each(function() {
                var productCell = $(this).find('td:eq(3)').text().trim();
                var dateCell = $(this).find('td:eq(2)').text().trim();
                var dateMatch = true;
                
                // Process date filtering
                if (fromDate || toDate) {
                    // Convert date format from DD.MM.YYYY to Date object for comparison
                    var recordDate;
                    if (dateCell.includes('.')) {
                        var parts = dateCell.split('.');
                        // Parse the date parts as integers to avoid leading zeros issues
                        var day = parseInt(parts[0], 10);
                        var month = parseInt(parts[1], 10);
                        var year = parseInt(parts[2], 10);
                        
                        // Create date object for comparison
                        recordDate = new Date(year, month - 1, day);
                    } else if (dateCell) {
                        // Handle YYYY-MM-DD format
                        recordDate = new Date(dateCell);
                    }
                    
                    // Set record date to midnight for fair comparison
                    if (recordDate) {
                        recordDate.setHours(0, 0, 0, 0);
                    }
                    
                    // Check if we should filter for a single date
                    if (fromDate && toDate && fromDate === toDate) {
                        // Same date selected twice - filter for exactly this date
                        var exactDate = new Date(fromDate);
                        exactDate.setHours(0, 0, 0, 0);
                        
                        // Compare year, month, and day for exact match
                        dateMatch = recordDate && 
                                   recordDate.getFullYear() === exactDate.getFullYear() && 
                                   recordDate.getMonth() === exactDate.getMonth() && 
                                   recordDate.getDate() === exactDate.getDate();
                    } else {
                        // Normal date range filtering
                        if (fromDate) {
                            var fromDateObj = new Date(fromDate);
                            fromDateObj.setHours(0, 0, 0, 0);
                            dateMatch = dateMatch && recordDate && recordDate >= fromDateObj;
                        }
                        
                        if (toDate) {
                            var toDateObj = new Date(toDate);
                            toDateObj.setHours(0, 0, 0, 0);
                            dateMatch = dateMatch && recordDate && recordDate <= toDateObj;
                        }
                    }
                }
                
                var productMatch = !selectedProduct || productCell === selectedProduct;
                
                if (productMatch && dateMatch) {
                    $(this).show();
                } else {
                    $(this).hide();
                }
            });
        }
    });
</script>
{% endblock %}
