{% extends "layout.html" %}

{% block title %}Faste Givere{% endblock %}

{% block head_scripts %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/css/bootstrap.min.css">
<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.css" />
{% endblock %}

{% block additional_styles %}
<style>
    body {
        text-align: center;
    }
    
    .container {
        margin-top: 15px !important;
    }
    
    h1 {
        color: rgb(33, 31, 32);
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        font-size: 20px;
        font-weight: 700;
        margin: 0 0 10px 0;
        padding: 0;
        text-align: center;
    }
    
    .donors-table {
        width: 100%;
        max-width: 400px;
        margin: 20px auto;
        border-collapse: collapse;
        background-color: white;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        border-radius: 8px;
        overflow: hidden;
        font-size: 12px;
    }
    
    .donors-table th {
        background-color: var(--primary-color);
        color: white;
        padding: 6px 8px;
        text-align: left;
        font-weight: 600;
        font-size: 11px;
    }
    
    .sortable {
        cursor: pointer;
        position: relative;
    }
    
    .sortable:hover {
        background-color: #e64500;
    }
    
    .sort-icon {
        display: inline-block;
        margin-left: 5px;
        font-size: 10px;
    }
    
    .donors-table td {
        padding: 5px 8px;
        border-bottom: 1px solid #eee;
        text-align: left;
        white-space: nowrap;
    }
    
    .donors-table tr:last-child td {
        border-bottom: none;
    }
    
    .donors-table tr:nth-child(even) {
        background-color: #f9f9f9;
    }
    
    .donors-table tr:hover {
        background-color: #f1f1f1;
    }
    
    .filter-controls {
        margin: 20px 0;
    }
    
    .filter-card {
        background-color: white;
        border-radius: 10px;
        box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        padding: 15px;
        margin-bottom: 20px;
    }
    
    .filter-section {
        display: flex;
        flex-direction: column;
        gap: 15px;
        margin-bottom: 15px;
    }
    
    .filter-item {
        display: flex;
        flex-direction: column;
    }
    
    .filter-item label {
        font-size: 12px;
        font-weight: 600;
        margin-bottom: 5px;
        color: #555;
    }
    
    .select-wrapper {
        position: relative;
    }
    
    .select-wrapper::after {
        content: '\25BC';
        position: absolute;
        right: 10px;
        top: 50%;
        transform: translateY(-50%);
        pointer-events: none;
        font-size: 10px;
        color: var(--primary-color);
    }
    
    .filter-item select {
        appearance: none;
        width: 100%;
        padding: 8px 10px;
        border: 1px solid #ddd;
        border-radius: 6px;
        background-color: #f9f9f9;
        font-size: 13px;
        cursor: pointer;
    }
    
    .date-picker-wrapper {
        position: relative;
    }
    
    .date-picker-wrapper input {
        width: 100%;
        padding: 8px 10px;
        border: 1px solid #ddd;
        border-radius: 6px;
        background-color: #f9f9f9;
        font-size: 13px;
        cursor: pointer;
    }
    
    .date-icon {
        position: absolute;
        right: 10px;
        top: 50%;
        transform: translateY(-50%);
        pointer-events: none;
        font-size: 14px;
    }
    
    .filter-actions {
        display: flex;
        gap: 10px;
        justify-content: flex-end;
    }
    
    .filter-button {
        padding: 8px 15px;
        border: none;
        border-radius: 6px;
        font-size: 13px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
    }
    
    .filter-button.primary {
        background-color: var(--primary-color);
        color: white;
    }
    
    .filter-button.primary:hover {
        background-color: #e64500;
    }
    
    .filter-button.secondary {
        background-color: #f0f0f0;
        color: #555;
    }
    
    .filter-button.secondary:hover {
        background-color: #e0e0e0;
    }
    
    /* Date picker custom styles */
    .daterangepicker {
        border-radius: 8px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        border: 1px solid #eee;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    
    .daterangepicker .calendar-table {
        border-radius: 6px;
    }
    
    .daterangepicker td.active, .daterangepicker td.active:hover {
        background-color: var(--primary-color);
    }
    
    .daterangepicker td.in-range {
        background-color: rgba(252, 76, 2, 0.1);
    }
    
    .daterangepicker .drp-buttons .btn {
        border-radius: 4px;
    }
    
    .summary-box {
        display: flex;
        justify-content: space-around;
        background-color: white;
        border-radius: 8px;
        padding: 15px;
        margin: 20px 0;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    
    .summary-stat {
        display: inline-block;
        margin: 0 20px;
        text-align: center;
    }
    
    .summary-value {
        font-size: 22px;
        font-weight: bold;
        color: var(--primary-color);
    }
    
    .summary-label {
        font-size: 14px;
        color: #666;
    }
    
    .payment-method {
        display: inline-block;
        padding: 2px 4px;
        border-radius: 3px;
        font-size: 10px;
        font-weight: 600;
        color: white;
        background-color: #6c757d;
    }
    
    .payment-method.Vipps {
        background-color: #ff5b24; /* Orange for Vipps */
    }
    
    .payment-method.SMS {
        background-color: #28a745; /* Green for SMS */
    }
    
    .payment-method.Stripe {
        background-color: #007bff; /* Blue for Stripe */
    }
    
    .payment-method.Avtalegiro {
        background-color: #6c757d; /* Gray for Avtalegiro */
    }
    
    .payment-method-link {
        text-decoration: none;
        display: inline-block;
    }
    
    .payment-method-link:hover .payment-method {
        opacity: 0.9;
        transform: scale(1.05);
        transition: all 0.2s ease;
    }
    
    .donor-link {
        color: #0066cc;
        text-decoration: none;
        font-weight: 500;
    }
    
    .donor-link:hover {
        text-decoration: underline;
        color: #004c99;
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <h1>Rekrutterte faste givere</h1>
    
    <div class="filter-controls">
        <div class="filter-card">
            <div class="filter-section">
                <div class="filter-item">
                    <label for="product-filter">Produkt</label>
                    <div class="select-wrapper">
                        <select id="product-filter">
                            <option value="">Alle produkter</option>
                            {% for product in products %}
                            <option value="{{ product }}">{{ product }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                
                <div class="filter-item">
                    <label for="payment-filter">BetalingsmÃ¥te</label>
                    <div class="select-wrapper">
                        <select id="payment-filter">
                            <option value="">Alle betalingsmÃ¥ter</option>
                            {% for payment_method in payment_methods %}
                            <option value="{{ payment_method }}">{{ payment_method }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                
                <div class="filter-item">
                    <label for="daterange">Periode</label>
                    <div class="date-picker-wrapper">
                        <input type="text" id="daterange" placeholder="Velg datoperiode" readonly>
                        <i class="date-icon">ðŸ“…</i>
                    </div>
                </div>
            </div>
            
            <div class="filter-actions">
                <button id="apply-filters" class="filter-button primary">Bruk filter</button>
                <button id="reset-filters" class="filter-button secondary">Nullstill</button>
            </div>
        </div>
    </div>
    
    <div class="summary-box">
        <div class="summary-stat">
            <div class="summary-value">{{ total_donors }}</div>
            <div class="summary-label">Totalt antall givere</div>
        </div>
        <div class="summary-stat">
            <div class="summary-value">{{ total_amount|int }} kr</div>
            <div class="summary-label">Ã…rlig verdi</div>
        </div>
    </div>
    
    <table class="donors-table">
        <thead>
            <tr>
                <th>Avtale</th>
                <th>Ã…rsbelÃ¸p</th>
                <th class="sortable" data-sort="date" id="date-header">Startdato <span class="sort-icon">â–¼</span></th>
                <th>Produkt</th>
            </tr>
        </thead>
        <tbody>
            {% for donor in donors %}
            <tr>
                <td>
                    <a href="https://bymisjon.profundo.no/crm/navn/{{ donor.name_id }}/avtale/{{ donor.agreement_number }}" target="_blank" class="payment-method-link" title="Ã…pne avtale i Profundo">
                        <span class="payment-method {{ donor.payment_method }}">
                            {{ donor.payment_method }} â†—
                        </span>
                    </a>
                </td>
                <td><span style="white-space: nowrap;">{{ donor.amount|int }} kr</span></td>
                <td>{{ donor.startdate }}</td>
                <td>{{ donor.producttype_id }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endblock %}

{% block scripts %}
<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.bundle.min.js"></script>
<script type="text/javascript" src="https://cdn.jsdelivr.net/momentjs/latest/moment.min.js"></script>
<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.min.js"></script>
<script>
    $(document).ready(function() {
        // Initialize date range picker with no default selection
        $('#daterange').daterangepicker({
            opens: 'left',
            autoApply: false,
            autoUpdateInput: false, // Don't set a default date
            locale: {
                format: 'DD.MM.YYYY',
                separator: ' - ',
                applyLabel: 'Bruk',
                cancelLabel: 'Avbryt',
                fromLabel: 'Fra',
                toLabel: 'Til',
                customRangeLabel: 'Egendefinert',
                weekLabel: 'U',
                daysOfWeek: ['SÃ¸', 'Ma', 'Ti', 'On', 'To', 'Fr', 'LÃ¸'],
                monthNames: ['Januar', 'Februar', 'Mars', 'April', 'Mai', 'Juni', 'Juli', 'August', 'September', 'Oktober', 'November', 'Desember'],
                firstDay: 1
            },
            ranges: {
               'I dag': [moment(), moment()],
               'I gÃ¥r': [moment().subtract(1, 'days'), moment().subtract(1, 'days')],
               'Siste 7 dager': [moment().subtract(6, 'days'), moment()],
               'Siste 30 dager': [moment().subtract(29, 'days'), moment()],
               'Denne mÃ¥neden': [moment().startOf('month'), moment().endOf('month')],
               'Forrige mÃ¥ned': [moment().subtract(1, 'month').startOf('month'), moment().subtract(1, 'month').endOf('month')]
            }
        });
        
        // Handle apply and cancel events
        $('#daterange').on('apply.daterangepicker', function(ev, picker) {
            $(this).val(picker.startDate.format('DD.MM.YYYY') + ' - ' + picker.endDate.format('DD.MM.YYYY'));
        });
        
        $('#daterange').on('cancel.daterangepicker', function(ev, picker) {
            $(this).val('');
        });
        
        // Initialize table sorting - default to descending order for startdate
        var currentSortField = 'date';
        var currentSortOrder = 'desc'; // Default to descending (newest first)
        sortTable(currentSortField, currentSortOrder);
        
        // Add click handler for sortable columns
        $('.sortable').on('click', function() {
            var sortField = $(this).data('sort');
            
            // If clicking the same column, toggle sort order
            if (sortField === currentSortField) {
                currentSortOrder = currentSortOrder === 'asc' ? 'desc' : 'asc';
            } else {
                currentSortField = sortField;
                currentSortOrder = 'asc';
            }
            
            // Update sort icon
            updateSortIcon($(this), currentSortOrder);
            
            // Sort the table
            sortTable(currentSortField, currentSortOrder);
        });
        
        // Apply filters button click handler
        $('#apply-filters').on('click', function() {
            filterTable();
        });
        
        // Reset filters button click handler
        $('#reset-filters').on('click', function() {
            // Reset all filters
            $('#product-filter').val('');
            $('#payment-filter').val('');
            $('#daterange').val('');
            
            // Clear the date range picker
            $('#daterange').data('daterangepicker').setStartDate(moment());
            $('#daterange').data('daterangepicker').setEndDate(moment());
            $('#daterange').val('');
            
            // Apply the reset filters
            filterTable();
        });
        
        // Function to update sort icon based on sort order
        function updateSortIcon(headerElement, sortOrder) {
            // Remove all sort icons
            $('.sort-icon').html('');
            
            // Add appropriate icon to current sort column
            var icon = sortOrder === 'asc' ? 'â–²' : 'â–¼';
            headerElement.find('.sort-icon').html(icon);
        }
        
        // Function to sort the table based on field and order
        function sortTable(field, order) {
            var tbody = $('.donors-table tbody');
            var rows = tbody.find('tr').toArray();
            
            // Sort the rows based on the specified field and order
            rows.sort(function(a, b) {
                var aValue, bValue;
                
                if (field === 'date') {
                    // Get date values from the third column (index 2)
                    var aText = $(a).find('td:eq(2)').text().trim();
                    var bText = $(b).find('td:eq(2)').text().trim();
                    
                    // Parse dates for comparison
                    aValue = parseDate(aText);
                    bValue = parseDate(bText);
                }
                
                // Compare the values based on sort order
                if (order === 'asc') {
                    return aValue < bValue ? -1 : aValue > bValue ? 1 : 0;
                } else {
                    return aValue > bValue ? -1 : aValue < bValue ? 1 : 0;
                }
            });
            
            // Reattach sorted rows to the table
            $.each(rows, function(index, row) {
                tbody.append(row);
            });
            
            // Apply any active filters after sorting
            filterTable();
        }
        
        // Helper function to parse dates in various formats
        function parseDate(dateStr) {
            if (!dateStr) return new Date(0); // Handle empty dates
            
            var date;
            if (dateStr.includes('.')) {
                // Parse DD.MM.YYYY format
                var parts = dateStr.split('.');
                var day = parseInt(parts[0], 10);
                var month = parseInt(parts[1], 10);
                var year = parseInt(parts[2], 10);
                date = new Date(year, month - 1, day);
            } else {
                // Handle YYYY-MM-DD format
                date = new Date(dateStr);
            }
            
            return isNaN(date.getTime()) ? new Date(0) : date;
        }
        
        function filterTable() {
            var selectedProduct = $('#product-filter').val();
            var selectedPayment = $('#payment-filter').val();
            var dateRange = $('#daterange').val();
            
            // Parse date range if selected
            var fromDate = null;
            var toDate = null;
            if (dateRange) {
                var dates = dateRange.split(' - ');
                if (dates.length === 2) {
                    fromDate = moment(dates[0], 'DD.MM.YYYY').toDate();
                    toDate = moment(dates[1], 'DD.MM.YYYY').toDate();
                }
            }
            
            $('.donors-table tbody tr').each(function() {
                var productCell = $(this).find('td:eq(3)').text().trim();
                var dateCell = $(this).find('td:eq(2)').text().trim();
                var paymentCell = $(this).find('td:eq(0)').find('.payment-method').text().trim();
                
                // Remove the arrow symbol from payment method
                paymentCell = paymentCell.replace('â†—', '').trim();
                
                var dateMatch = true;
                var productMatch = !selectedProduct || productCell === selectedProduct;
                var paymentMatch = !selectedPayment || paymentCell === selectedPayment;
                
                // Process date filtering
                if (fromDate && toDate) {
                    // Convert date format from DD.MM.YYYY to Date object for comparison
                    var recordDate = parseDate(dateCell);
                    
                    // Set record date to midnight for fair comparison
                    if (recordDate) {
                        recordDate.setHours(0, 0, 0, 0);
                    }
                    
                    // Check if from and to dates are the same (single day filter)
                    if (fromDate.getTime() === toDate.getTime()) {
                        // Same date selected - filter for exactly this date
                        dateMatch = recordDate && 
                                   recordDate.getFullYear() === fromDate.getFullYear() && 
                                   recordDate.getMonth() === fromDate.getMonth() && 
                                   recordDate.getDate() === fromDate.getDate();
                    } else {
                        // Normal date range filtering
                        fromDate.setHours(0, 0, 0, 0);
                        toDate.setHours(23, 59, 59, 999); // End of day
                        dateMatch = recordDate && recordDate >= fromDate && recordDate <= toDate;
                    }
                }
                
                // Show row if all filters match
                if (productMatch && dateMatch && paymentMatch) {
                    $(this).show();
                } else {
                    $(this).hide();
                }
            });
            
            // Update the count of visible rows
            updateVisibleCount();
        }
        
        // Function to update the count of visible rows
        function updateVisibleCount() {
            var visibleRows = $('.donors-table tbody tr:visible').length;
            var totalAmount = 0;
            
            // Calculate total amount from visible rows
            $('.donors-table tbody tr:visible').each(function() {
                var amountText = $(this).find('td:eq(1)').text().trim();
                var amount = parseInt(amountText.replace(/[^0-9]/g, ''));
                if (!isNaN(amount)) {
                    totalAmount += amount;
                }
            });
            
            // Update the summary box
            $('.summary-value').eq(0).text(visibleRows);
            $('.summary-value').eq(1).text(totalAmount.toLocaleString('no-NO') + ' kr');
        }
    });
</script>
{% endblock %}
