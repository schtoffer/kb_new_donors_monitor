{% extends "layout.html" %}

{% block title %}Alternative 2{% endblock %}

{% block head_scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
{% endblock %}

{% block additional_styles %}
<style>
    .chart-container, .stats-container {
        width: 100%;
        margin: 2rem auto;
        padding: 1.5rem;
        background-color: transparent;
    }
    
    .stats-container {
        text-align: center;
        margin-top: 2rem;
    }
    
    .stat-value {
        font-size: 2.8rem;
        font-weight: bold;
        color: var(--primary-color);
        margin-bottom: 0.5rem;
    }
    
    .stat-label {
        color: var(--secondary-color);
        font-size: 1.2rem;
    }
    
    /* Heartwarming element styling */
    .heart-container {
        text-align: center;
        margin-bottom: 1rem;
    }
    
    .heart {
        display: inline-block;
        position: relative;
        width: 50px;
        height: 45px;
        animation: heartbeat 1.5s ease-in-out infinite;
    }
    
    .heart:before,
    .heart:after {
        content: "";
        position: absolute;
        left: 25px;
        top: 0;
        width: 25px;
        height: 40px;
        background: var(--primary-color);
        border-radius: 50px 50px 0 0;
        transform: rotate(-45deg);
        transform-origin: 0 100%;
    }
    
    .heart:after {
        left: 0;
        transform: rotate(45deg);
        transform-origin: 100% 100%;
    }
    
    @keyframes heartbeat {
        0% { transform: scale(1); }
        25% { transform: scale(1.1); }
        50% { transform: scale(1); }
        75% { transform: scale(1.1); }
        100% { transform: scale(1); }
    }
    
    h1 {
        color: rgb(33, 31, 32);
        font-family: neuzeit-grotesk, sans-serif;
        font-size: 28.5344px;
        font-weight: 700;
        line-height: 42.8016px;
        margin: 0;
        padding: 0;
        text-align: center;
        box-sizing: border-box;
    }
    
    canvas {
        max-height: 200px;
    }
</style>
{% endblock %}

{% block content %}
<div class="heart-container">
    <div class="heart"></div>
</div>
<h1 class="text-center mb-4">Nye faste givere i dag - Alternative 2</h1>

<div class="chart-container">
    <canvas id="donorChart"></canvas>
</div>

<div class="stats-container row">
    <div class="col-6">
        <div class="stat-value" id="newDonorsToday">--</div>
        <div class="stat-label">Nye faste givere i dag</div>
    </div>
    <div class="col-6">
        <div class="stat-value" id="averageNewDonors">--</div>
        <div class="stat-label">Gjennomsnitt siste 30 dager</div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Get the canvas element
    const ctx = document.getElementById('donorChart').getContext('2d');
    
    // Create the chart
    const donorChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: [],
            datasets: [{
                label: 'Nye faste givere',
                data: [],
                backgroundColor: '#FC4C02',
                borderColor: '#FC4C02',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    callbacks: {
                        title: function(tooltipItems) {
                            const date = new Date(tooltipItems[0].label);
                            return date.toLocaleDateString('no-NO', { 
                                weekday: 'long', 
                                year: 'numeric', 
                                month: 'long', 
                                day: 'numeric' 
                            });
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        precision: 0
                    }
                },
                x: {
                    ticks: {
                        callback: function(value, index, values) {
                            const date = new Date(this.getLabelForValue(value));
                            return date.toLocaleDateString('no-NO', { day: 'numeric', month: 'short' });
                        }
                    }
                }
            },
            animation: {
                onComplete: function() {
                    afterDraw(this);
                }
            }
        }
    });
    
    function afterDraw(chart) {
        if (chart.data.datasets.length === 0) {
            // No data is present
            const ctx = chart.ctx;
            const width = chart.width;
            const height = chart.height;
            
            chart.clear();
            
            ctx.save();
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.font = '16px Arial';
            ctx.fillStyle = '#666';
            ctx.fillText('Ingen data tilgjengelig', width / 2, height / 2);
            ctx.restore();
        }
    }
    
    // Function to fetch data and update the chart
    function updateChart() {
        // Get today's date
        const today = new Date();
        
        // Get the date 7 days ago
        const sevenDaysAgo = new Date();
        sevenDaysAgo.setDate(today.getDate() - 7);
        
        // Format dates for display
        const formatDate = (date) => {
            return date.toISOString().split('T')[0];
        };
        
        // Generate dates for the last 7 days
        const dates = [];
        const currentDate = new Date(sevenDaysAgo);
        
        while (currentDate <= today) {
            dates.push(formatDate(currentDate));
            currentDate.setDate(currentDate.getDate() + 1);
        }
        
        // Fetch data from API
        fetch('/api/today')
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                // Update stats
                document.getElementById('newDonorsToday').textContent = data.n_new_donors;
                document.getElementById('averageNewDonors').textContent = data.average_n_new_donors_last_30_days;
                
                // For demo purposes, generate random data for the chart
                const donorCounts = [];
                
                // Use the actual value for today
                for (let i = 0; i < dates.length - 1; i++) {
                    // Random values between 15 and 50 for previous days
                    donorCounts.push(Math.floor(Math.random() * 35) + 15);
                }
                
                // Add today's actual value
                donorCounts.push(data.n_new_donors);
                
                // Update chart data
                donorChart.data.labels = dates;
                donorChart.data.datasets[0].data = donorCounts;
                donorChart.update();
            })
            .catch(error => {
                console.error('Error fetching data:', error);
                
                // If there's an error, show placeholder data
                const placeholderData = dates.map(() => Math.floor(Math.random() * 35) + 15);
                
                document.getElementById('newDonorsToday').textContent = placeholderData[placeholderData.length - 1];
                document.getElementById('averageNewDonors').textContent = Math.round(
                    placeholderData.reduce((sum, value) => sum + value, 0) / placeholderData.length
                );
                
                donorChart.data.labels = dates;
                donorChart.data.datasets[0].data = placeholderData;
                donorChart.update();
            });
    }
    
    // Initial chart load
    updateChart();
</script>
{% endblock %}
