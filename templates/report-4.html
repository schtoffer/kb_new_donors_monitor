{% extends "layout.html" %}

{% block title %}Nye Faste Givere i Dag{% endblock %}

{% block head_scripts %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">
{% endblock %}

{% block additional_styles %}
<style>
    body {
        text-align: center;
    }
    
    /* Reduce space above content */
    .container {
        margin-top: 15px !important;
    }
    
    h1 {
        color: rgb(33, 31, 32);
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        font-size: 24px;
        font-weight: 700;
        margin: 0 0 15px 0;
        padding: 0;
        text-align: center;
    }
    
    .impact-container {
        margin: 15px auto;
        max-width: 460px;
        padding: 0 10px;
    }
    
    .impact-number {
        font-size: 60px;
        font-weight: bold;
        color: var(--primary-color);
        margin: 5px 0;
    }
    
    .impact-text {
        font-size: 18px;
        margin-bottom: 20px;
        max-width: 460px;
        margin-left: auto;
        margin-right: auto;
    }
    
    .hearts-container {
        display: flex;
        justify-content: center;
        margin: 15px 0;
        flex-wrap: wrap;
        max-width: 95%;
        margin-left: auto;
        margin-right: auto;
    }
    
    .heart {
        display: inline-block;
        position: relative;
        width: 20px;
        height: 20px;
        margin: 6px;
        opacity: 0;
        animation: fadeIn 0.5s forwards, pulse 2s infinite ease-in-out;
    }
    
    .heart:before,
    .heart:after {
        content: "";
        position: absolute;
        left: 10px;
        top: 0;
        width: 10px;
        height: 16px;
        background: var(--primary-color);
        border-radius: 10px 10px 0 0;
        transform: rotate(-45deg);
        transform-origin: 0 100%;
    }
    
    .heart:after {
        left: 0;
        transform: rotate(45deg);
        transform-origin: 100% 100%;
    }
    
    .message-container {
        margin: 20px auto;
        padding: 25px 15px;
        background-color: rgba(255, 255, 255, 0.7);
        border-radius: 10px;
        max-width: 460px;
    }
    
    .message-title {
        font-size: 24px;
        font-weight: bold;
        margin-bottom: 15px;
    }
    
    .comparison {
        display: flex;
        justify-content: space-around;
        margin: 20px 0;
    }
    
    .comparison-item {
        text-align: center;
    }
    
    .comparison-label {
        font-size: 16px;
        margin-bottom: 5px;
    }
    
    .comparison-value {
        font-size: 24px;
        font-weight: bold;
    }
    
    .average {
        color: #4a90e2;
    }
    
    .payment-method-breakdown {
        margin-top: 20px;
        text-align: left;
        padding: 0 15px;
    }
    
    .payment-method-item {
        display: flex;
        justify-content: space-between;
        margin-bottom: 8px;
    }
    
    .payment-method-label {
        font-weight: 500;
        padding: 2px 6px;
        border-radius: 4px;
        display: inline-block;
        color: white;
    }
    
    /* Payment method specific colors */
    .payment-method-label.Vipps {
        background-color: #ff5b24; /* Orange for Vipps */
    }
    
    .payment-method-label.SMS {
        background-color: #28a745; /* Green for SMS */
    }
    
    .payment-method-label.Stripe {
        background-color: #007bff; /* Blue for Stripe */
    }
    
    .payment-method-label.Avtalegiro {
        background-color: #6c757d; /* Gray for Avtalegiro */
    }
    
    .payment-method-value {
        font-weight: bold;
    }
    
    @keyframes fadeIn {
        0% {
            opacity: 0;
        }
        100% {
            opacity: 1;
        }
    }
    
    @keyframes pulse {
        0% {
            transform: scale(1);
        }
        50% {
            transform: scale(1.1);
        }
        100% {
            transform: scale(1);
        }
    }
    
    .product-breakdown {
        margin-top: 20px;
        text-align: left;
        padding: 0 15px;
    }
    
    .product-item {
        display: flex;
        justify-content: space-between;
        margin-bottom: 8px;
    }
    
    .product-label {
        font-weight: 500;
    }
    
    .product-value {
        font-weight: bold;
    }
</style>
{% endblock %}

{% block content %}
    
    <div class="container">
        <h1>I dag slår</h1>
        
        <div class="impact-container">
            <div class="impact-number" id="newDonorsToday">--</div>
            <div class="impact-text">
                nye hjerter for et varmere samfunn
            </div>
            
            <div id="hearts-container" class="hearts-container">
                <!-- Hearts will be added here dynamically -->
            </div>
            
            <div class="comparison">
                <div class="comparison-item">
                    <div class="comparison-label">Snittet siste 30 dager er</div>
                    <div class="comparison-value average" id="averageValue">--</div>
                </div>
            </div>
        </div>
        
        <div class="message-container animate__animated animate__fadeIn">
            <h1>Hva betyr dette?</h1>
            <div class="message-content">
                Bak hvert hjerte står en person som har valgt å støtte oss med et fast beløp hver måned. 
                Takket være dem kan vi hjelpe flere mennesker hver eneste dag.
                <br><br>
                De <span id="donorCount">--</span> nye faste giverne vi har fått i dag vil gi oss <span id="yearlyValueNewDonors">--</span> kr i året.
                <br><br>
                <div class="payment-method-breakdown">
                    <h3>Betalingsmåte</h3>
                    <div id="paymentMethodBreakdown">
                        <!-- Payment method breakdown will be added here -->
                    </div>
                </div>
                <div class="product-breakdown">
                    <h3>Produkter</h3>
                    <div id="productBreakdown">
                        <!-- Product breakdown will be added here -->
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // Function to fetch data and update the display
        function updateDisplay() {
            // Fetch data from API
            fetch('/api/new-donors-today')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    // Update the UI with the data from the server
                    const donorCount = data.count;
                    const yearlyValue = data.yearly_value;
                    const averageNewDonors = data.average_new_donors_last_30_days;
                    
                    // Update the UI
                    document.getElementById('newDonorsToday').textContent = donorCount;
                    document.getElementById('donorCount').textContent = donorCount;
                    document.getElementById('yearlyValueNewDonors').textContent = yearlyValue.toLocaleString('no-NO');
                    document.getElementById('averageValue').textContent = averageNewDonors;
                    
                    // Create hearts based on the number of new donors
                    createHearts(donorCount);
                    
                    // Update payment method breakdown
                    const paymentMethodBreakdown = document.getElementById('paymentMethodBreakdown');
                    paymentMethodBreakdown.innerHTML = '';
                    Object.entries(data.payment_methods).forEach(([method, count]) => {
                        const methodItem = document.createElement('div');
                        methodItem.className = 'payment-method-item';
                        
                        const methodLabel = document.createElement('div');
                        methodLabel.className = `payment-method-label ${method}`;
                        methodLabel.textContent = method;
                        
                        const methodValue = document.createElement('div');
                        methodValue.className = 'payment-method-value';
                        methodValue.textContent = count;
                        
                        methodItem.appendChild(methodLabel);
                        methodItem.appendChild(methodValue);
                        paymentMethodBreakdown.appendChild(methodItem);
                    });
                    
                    // Update product breakdown
                    const productBreakdown = document.getElementById('productBreakdown');
                    productBreakdown.innerHTML = '';
                    Object.entries(data.products).forEach(([product, count]) => {
                        const productItem = document.createElement('div');
                        productItem.className = 'product-item';
                        
                        const productLabel = document.createElement('div');
                        productLabel.className = 'product-label';
                        productLabel.textContent = product;
                        
                        const productValue = document.createElement('div');
                        productValue.className = 'product-value';
                        productValue.textContent = count;
                        
                        productItem.appendChild(productLabel);
                        productItem.appendChild(productValue);
                        productBreakdown.appendChild(productItem);
                    });
                })
                .catch(error => {
                    console.error('Error fetching data:', error);
                    
                    // If there's an error, show placeholder data
                    const placeholderDonors = Math.floor(Math.random() * 35) + 15;
                    const placeholderAverage = Math.floor(Math.random() * 30) + 15;
                    const placeholderYearlyValue = placeholderDonors * 720; // Assuming average annual value of 720 per donor
                    
                    document.getElementById('newDonorsToday').textContent = placeholderDonors;
                    document.getElementById('donorCount').textContent = placeholderDonors;
                    document.getElementById('averageValue').textContent = placeholderAverage;
                    document.getElementById('yearlyValueNewDonors').textContent = placeholderYearlyValue.toLocaleString('no-NO');
                    
                    // Create hearts based on the placeholder number
                    createHearts(placeholderDonors);
                    
                    // Add placeholder payment methods
                    const paymentMethodBreakdown = document.getElementById('paymentMethodBreakdown');
                    paymentMethodBreakdown.innerHTML = `
                        <div class="payment-method-item">
                            <div class="payment-method-label">Avtalegiro</div>
                            <div class="payment-method-value">${Math.floor(placeholderDonors * 0.6)}</div>
                        </div>
                        <div class="payment-method-item">
                            <div class="payment-method-label">Vipps</div>
                            <div class="payment-method-value">${Math.floor(placeholderDonors * 0.4)}</div>
                        </div>
                    `;
                    
                    // Add placeholder products
                    const productBreakdown = document.getElementById('productBreakdown');
                    productBreakdown.innerHTML = `
                        <div class="product-item">
                            <div class="product-label">Fadder</div>
                            <div class="product-value">${Math.floor(placeholderDonors * 0.4)}</div>
                        </div>
                        <div class="product-item">
                            <div class="product-label">Generell</div>
                            <div class="product-value">${Math.floor(placeholderDonors * 0.6)}</div>
                        </div>
                    `;
                });
        }
        
        // Function to create hearts based on the number of new donors
        function createHearts(count) {
            const heartsContainer = document.getElementById('hearts-container');
            heartsContainer.innerHTML = '';
            
            // Show all hearts, no limit
            for (let i = 0; i < count; i++) {
                const heart = document.createElement('div');
                heart.className = 'heart';
                // All hearts will fade in together and pulse simultaneously
                heart.style.animationDelay = '0s';
                heartsContainer.appendChild(heart);
            }
        }
        
        // Initial display update
        updateDisplay();
        
    </script>
{% endblock %}

{% block scripts %}
<script>
    // Initial display update
    updateDisplay();
</script>
{% endblock %}
